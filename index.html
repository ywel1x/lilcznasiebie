<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Licz na siebie! v51.0 (Animacje + Fixy)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --c-hp: #0f0;
            --c-danger: #ff3333;
            --c-gold: #ffd700;
            --c-brain: #2196F3;
            --wood-dark: #4a2810;
            --wood-light: #8b4513;
            --base-size: 220px;
        }

        * { box-sizing: border-box; }

        html { height: 100%; overflow: hidden; }

        body {
            background: #111;
            color: #fff;
            font-family: 'VT323', monospace;
            margin: 0; padding: 0;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            height: 100dvh; 
            display: flex; justify-content: center; align-items: center;
            touch-action: manipulation; user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
            padding-top: env(safe-area-inset-top);
        }

        #main-container {
            position: relative; width: 100%; height: 100%;
            max-width: 600px; 
            background: transparent; 
            overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- T≈ÅA --- */
        .game-bg {
            position: absolute; top:0; left:0; width:100%; height:100%; z-index: -2;
            transition: opacity 1.5s ease;
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        #bg-day { background-image: url('day.png'); opacity: 1; }
        #bg-night { background-image: url('night.png'); opacity: 0; }
        body.night #bg-day { opacity: 0; }
        body.night #bg-night { opacity: 1; }

        #transition-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; background: transparent; opacity: 0; pointer-events: none;
            transition: opacity 0.8s ease-in-out;
        }

        /* --- UI DREWNIANE --- */
        .wood-btn {
            font-family: 'VT323', monospace; font-size: 2.2rem;
            color: #f0e68c;
            background: linear-gradient(to bottom, var(--wood-light), var(--wood-dark));
            border: 4px solid #2e1a0a; border-radius: 15px;
            padding: 15px 20px; margin: 10px 0;
            cursor: pointer; text-shadow: 2px 2px 4px #000;
            box-shadow: 0 6px #1a0f05, 0 10px 20px rgba(0,0,0,0.5);
            width: 85%; text-align: center; position: relative; line-height: 1;
        }
        .wood-btn:active { transform: translateY(4px); box-shadow: 0 2px #1a0f05, 0 5px 10px rgba(0,0,0,0.5); }
        .wood-btn::before {
            content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
            background: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, transparent 2px, rgba(0,0,0,0.05) 4px);
            border-radius: 12px; pointer-events: none;
        }

        /* --- HUD --- */
        #hud {
            display: none; justify-content: space-between; align-items: center;
            padding: 8px 5px; background: rgba(0,0,0,0.85); border-bottom: 2px solid #555;
            font-size: 1.3rem; z-index: 10; width: 100%; flex-shrink: 0;
        }
        .hud-stat { display: flex; align-items: center; gap: 3px; }
        #timer-box { font-size: 1.6rem; font-weight: bold; }
        .night #timer-box { color: var(--c-danger); animation: pulseTime 1s infinite; }
        
        .bar-container { width: 50px; height: 12px; background: #333; border: 2px solid #fff; border-radius: 4px; overflow: hidden; position: relative; }
        
        /* PASEK HP - POPRAWIONY */
        .hud-bar-thick { height: 24px; width: 130px; position: relative; border: 3px solid #fff; border-radius: 8px; background: #333; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #hp-fill { height: 100%; background: var(--c-hp); transition: width 0.2s; }
        #hp-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-align: center; line-height: 1; font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 3px #000, -1px -1px 3px #000; z-index: 2; letter-spacing: 1px; }

        #prog-fill { width: 0%; height: 100%; background: var(--c-brain); transition: width 0.3s; }

        /* --- GRA --- */
        #game-area {
            flex: 1; position: relative; display: none;
            flex-direction: column; align-items: center; justify-content: center; 
            overflow: hidden; width: 100%;
        }
        
        #base-visual { 
            width: var(--base-size); 
            height: var(--base-size); 
            background-image: url('base_sprites.png');
            background-repeat: no-repeat;
            background-size: calc(var(--base-size) * 4) calc(var(--base-size) * 2);
            image-rendering: pixelated; 
            z-index: 2; 
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6));
            transition: transform 0.2s;
            margin-top: 80px; 
        }
        
        #base-info { background:rgba(0,0,0,0.6); padding:5px 10px; border-radius:8px; margin-top:-10px; text-align:center; z-index:2; }
        #monster-power {
            position: absolute; top: 10%; right: 10%; background: #300; border: 2px solid var(--c-danger);
            color: var(--c-danger); padding: 5px 10px; border-radius: 5px;
            font-size: 1.2rem; font-weight: bold; opacity: 0; transition: opacity 0.3s; z-index: 5;
        }
        
        #monster {
            width: 25vh; height: 25vh; max-width: 150px; max-height: 150px;
            position: absolute; top: 15%; opacity: 0; z-index: 4;
            background-image: url('potwory.png'); 
            background-size: 500% 200%; 
            image-rendering: pixelated; filter: drop-shadow(0 0 15px rgba(255,0,0,0.7));
            transition: transform 0.5s linear;
        }
        .m-slime { background-position: 0% 0%; }     .m-goblin { background-position: 25% 0%; }
        .m-eye { background-position: 50% 0%; }      .m-golem { background-position: 75% 0%; }
        .m-fire { background-position: 100% 0%; }    .m-skeleton { background-position: 0% 100%; }
        .m-mushroom { background-position: 25% 100%; } .m-spider { background-position: 50% 100%; }
        .m-ghost { background-position: 75% 100%; }  .m-minotaur { background-position: 100% 100%; }

        .dropped-item {
            position: absolute; font-size: 4rem; cursor: pointer; z-index: 15;
            animation: bounce 1s infinite alternate; filter: drop-shadow(0 0 15px gold);
            padding: 20px; margin: -20px; 
        }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        
        .floating-msg {
            position: absolute; font-size: 2rem; font-weight: bold; color: #fff; 
            text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 20;
            animation: floatUpFade 2s forwards; 
            text-align: center;
            white-space: normal; 
            width: 90%;
            left: 50%; top: 40%; 
            transform: translate(-50%, -50%);
        }
        .msg-gold { color: gold; font-size: 2.5rem; text-shadow: 0 0 10px gold; }
        @keyframes floatUpFade { 0% { transform: translate(-50%, -50%); opacity: 1; } 100% { transform: translate(-50%, -150%); opacity: 0; } }

        /* --- NOWA ANIMACJA ZAKUPU --- */
        .ui-feedback {
            position: fixed;
            font-size: 1.8rem; font-weight: bold; color: #0f0;
            pointer-events: none; z-index: 1000;
            animation: floatUpUI 0.8s forwards;
            text-shadow: 1px 1px 0 #000;
        }
        @keyframes floatUpUI {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
        }

        /* --- PANEL STEROWANIA --- */
        #controls {
            background: #222; padding: 5px 10px; border-top: 3px solid #555;
            display: none; flex-direction: column; gap: 5px; z-index: 20;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.8); flex-shrink: 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            min-height: 350px; 
            justify-content: flex-start; 
        }
        #math-panel {
            background: #000; color: var(--c-hp); font-size: 2.2rem; text-align: center;
            padding: 5px; border: 2px solid var(--c-hp); border-radius: 8px;
            min-height: 45px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;
            flex-shrink: 0; 
        }
        #math-panel.locked { filter: blur(2px) grayscale(0.8); border-color: #555 !important; }
        
        #top-controls-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px; }
        #inventory-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 0; height: 50px; transition: opacity 0.3s; flex-grow: 1; }
        
        #btn-exit-game {
            font-family: 'VT323', monospace; font-size: 1.5rem; color: #f0e68c;
            background: linear-gradient(to bottom, var(--wood-light), var(--wood-dark));
            border: 3px solid #2e1a0a; border-radius: 8px;
            width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; margin-left: 10px; flex-shrink: 0; box-shadow: 0 4px #1a0f05;
        }
        #btn-exit-game:active { transform: translateY(2px); box-shadow: 0 2px #1a0f05; }

        .item-slot {
            width: 50px; height: 50px; background: #333; border: 2px solid #555; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
            position: relative; cursor: pointer; transition: all 0.1s;
        }
        .item-slot:active { transform: scale(0.9); }
        .item-count {
            position: absolute; bottom: -5px; right: -5px; background: #fff; color: #000;
            font-size: 0.9rem; padding: 1px 5px; border-radius: 50%; font-weight: bold;
        }
        .day-locked { opacity: 0.5; filter: grayscale(0.8); }
        .action-row { display: flex; gap: 8px; height: 55px; flex-shrink: 0; }
        .ctrl-btn {
            font-family: 'VT323', monospace; border: none; border-radius: 6px;
            font-size: 1.4rem; color: #fff; cursor: pointer;
            transition: all 0.1s; position: relative; overflow: hidden;
            line-height: 1.2; flex: 1;
        }
        .ctrl-btn:active { transform: translateY(2px); }
        #btn-gather { background: #4CAF50; border-bottom: 4px solid #2E7D32; }
        #btn-shop { background: #9C27B0; border-bottom: 4px solid #7B1FA2; }
        #btn-build { background: #555; border-bottom: 4px solid #333; color: #aaa; }
        #btn-build.ready { background: var(--c-gold); color: #000; border-bottom: 4px solid #b8860b; animation: pulseGold 1s infinite; font-weight: bold; }

        #keypad { display: none; grid-template-columns: repeat(3, 1fr); gap: 5px; height: 200px; margin-bottom: 5px; flex-shrink: 0; }
        .key { background: #444; font-size: 1.8rem; border-radius: 5px; border-bottom: 3px solid #222; flex: 1; font-family: 'VT323'; color:#fff; border:none; border-bottom: 3px solid #222; cursor: pointer;}
        .key:active { border-bottom: 0; transform:translateY(3px); }
        .key-ok { background: #2196F3; border-color: #0D47A1; }
        .key-fix { background: #FF9800; border-color: #E65100; font-size: 1.5rem; }
        #keypad.inactive { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        /* --- EKRANY I MODALE --- */
        .special-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200; display: none; 
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #main-menu-screen {
            background-color: #111;
            background-image: url('backgroundmenu.png');
            background-size: cover; background-position: center;
            z-index: 300;
            justify-content: flex-end; 
            padding-bottom: 80px; 
        }
        .app-version {
            position: absolute; bottom: 25px; 
            left: 5px;
            font-size: 0.8rem; color: rgba(255,255,255,0.3); font-family: sans-serif;
        }
        
        #difficulty-screen { background: rgba(0,0,0,0.95); z-index: 250; }
        #night-screen { background: linear-gradient(180deg, #001133 0%, #000000 100%); border: 5px solid #2196F3; }
        #game-over-screen { background: #000; border: 5px solid red; overflow-y: auto;}
        #mistakes-list { text-align: left; margin-top: 10px; font-size: 1.3rem; color: #ffaaaa; }
        
        .btn-next, .close-btn {
            font-size: 1.5rem; padding: 12px 30px; border-radius: 8px; margin-top: 20px; cursor: pointer;
            flex-grow: 0; width: auto; align-self: center; font-family: 'VT323'; border:none;
        }
        .btn-next { background: #2196F3; color: #fff; box-shadow: 0 4px #0D47A1; }
        .btn-next:active { transform: translateY(4px); box-shadow: none; }
        .close-btn { background: #d32f2f; color:#fff; box-shadow: 0 4px #9a0007; margin-bottom: 20px;}

        .modal { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 100; display: none; 
            flex-direction: column; padding: 15px; align-items: stretch; 
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: env(safe-area-inset-bottom);
        }
        .modal h2 { text-align: center; color: #fff; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .card-list { overflow-y: auto; flex: 1; }
        .card { background: #222; margin-bottom: 10px; padding: 12px; border: 2px solid #444; display: flex; align-items: center; gap: 12px; border-radius: 8px; }
        .card.affordable { border-color: var(--c-gold); background: #332b00; }
        .btn-buy { background: var(--c-gold); color: #000; font-weight: bold; padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; flex-grow: 0; font-family:'VT323'; }

        .menu-sprite {
            width: 60px; height: 60px;
            background-image: url('base_sprites.png');
            /* SKALOWANIE DO IKONY */
            background-size: 400% 200%;
            background-repeat: no-repeat;
            image-rendering: pixelated;
            border-radius: 8px; border: 2px solid #333;
        }
        
        .wood-modal-content {
            background: url('day.png'); background-size: cover;
            border: 5px solid #4a2810; border-radius: 15px;
            padding: 25px; text-align: center; max-width: 90%; margin: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9); position: relative;
        }
        .wood-modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(60, 30, 10, 0.85); z-index: -1; border-radius: 10px; }

        @keyframes pulseTime { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); color: red; } }
        @keyframes pulseGold { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 15px var(--c-gold); } }
        .shake-screen { animation: shake 0.2s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, -1px); } }
        .flash-red { position:absolute; top:0; left:0; width:100%; height:100%; background:red; opacity:0; pointer-events:none; z-index:50; transition: opacity 0.1s; }
    </style>
</head>
<body>

    <div id="main-container">
        
        <div id="bg-day" class="game-bg"></div>
        <div id="bg-night" class="game-bg"></div>
        <div id="transition-layer"></div>
        <div id="flash-overlay" class="flash-red"></div>

        <div id="main-menu-screen" class="special-screen" style="display: flex;">
            <button class="wood-btn" onclick="showDifficultySelect()">URUCHOM GRƒò</button>
            <div style="margin-top: 20px; color: #ccc; text-shadow: 1px 1px 2px #000; font-size: 1.2rem;">
                Autorzy: <span style="color:var(--c-gold)">Alan Lewe i Sebastian Lewe</span>
            </div>
            <div class="app-version">v51.0 (ANIMATIONS + ICON FIX)</div>
            <div style="position: absolute; bottom: 5px; width: 100%; text-align: center; font-size: 0.7rem; color: rgba(255,255,255,0.3); font-family: sans-serif;">
                Wszystkie prawa zastrze≈ºone | 2025 Koszalin
            </div>
        </div>

        <div id="difficulty-screen" class="special-screen">
            <h2>WYBIERZ POZIOM</h2>
            <button class="wood-btn" style="color: #4CAF50" onclick="selectTier(1)">≈ÅATWY (do 10)</button>
            <button class="wood-btn" style="color: #FF9800" onclick="selectTier(2)">≈öREDNI (do 20)</button>
            <button class="wood-btn" style="color: #F44336" onclick="selectTier(3)">TRUDNY (do 50)</button>
            <button class="wood-btn" style="color: #9C27B0" onclick="selectTier(4)">ULTRA (do 100)</button>
            <button class="wood-btn" style="color: #aaa; border-color: #555; background: linear-gradient(to bottom, #666, #333);" onclick="showMainMenu()">WR√ìƒÜ DO MENU</button>
        </div>

        <div id="night-screen" class="special-screen">
            <div style="font-size: 6rem;">üåÖ</div>
            <h1>PRZETRWA≈ÅE≈ö!</h1>
            <p style="font-size: 2rem; margin: 10px 0;">Przetrwa≈Çe≈õ <span id="night-summary-val">1 noc</span>.</p>
            <div id="streak-summary" style="color: gold; font-size: 1.3rem; margin-top: 10px;"></div>
            <button class="btn-next" onclick="startDay()">DALEJ >></button>
        </div>

        <div id="game-over-screen" class="special-screen">
            <h1>GAME OVER</h1>
            <p style="font-size: 2rem;">Przetrwa≈Çe≈õ <span id="final-night">0 nocy</span>.</p>
            <div id="recommendation" style="color: #2196F3; font-weight: bold; font-size: 1.2rem; margin: 10px 0;"></div>
            <div id="stats-container" style="background: #222; padding: 15px; width: 90%; border-radius: 10px; margin-top: 10px;">
                <h3 style="margin:0 0 10px 0; border-bottom:1px solid #555; font-size: 1.2rem; color: #aaa;">ZAPAMIƒòTAJ PONI≈ªSZE R√ìWNANIA, ≈ªEBY PRZETRWAƒÜ KOLEJNƒÑ NOC:</h3>
                <ul id="mistakes-list" style="list-style: none; padding: 0;"><li>Brak b≈Çƒôd√≥w! Brawo!</li></ul>
            </div>
            <button class="btn-next" style="background: red; box-shadow: 0 4px #9a0007;" onclick="hardReset()">WR√ìƒÜ DO MENU</button>
        </div>

        <div id="hud">
            <div class="hud-stat">üåô <span id="night-val">1</span></div>
            <div class="hud-stat" title="Seria poprawnych">üß† <div class="bar-container"><div id="prog-fill"></div></div></div>
            <div class="hud-stat"><span id="res-icon">ü™µ</span> <span id="res-count" style="color:orange">0</span></div>
            <div class="hud-stat">üí∞ <span id="gold-count" style="color:gold">0</span></div>
            <div id="timer-box">60s</div>
            <div class="hud-stat">‚ù§Ô∏è <div class="hud-bar-thick"><div id="hp-fill"></div><div id="hp-text">120/120</div></div></div>
        </div>

        <div id="game-area">
            <div id="monster-power">‚öîÔ∏è ATAK: <span id="m-dmg">0</span></div>
            <div id="monster"></div> 
            <div id="base-visual"></div>
            <div id="base-info">
                <div id="base-name" style="font-size: 1.2rem; font-weight:bold;">Namiot</div>
                <div style="color:#ccc; font-size:0.9rem;">üõ°Ô∏è Pancerz: <span id="base-def">1</span></div>
            </div>
        </div>

        <div id="build-menu" class="modal">
            <h2>ULEPSZ OB√ìZ</h2>
            <div id="build-list" class="card-list"></div>
            <button class="close-btn" onclick="closeModals()">ZAMKNIJ</button>
        </div>

        <div id="shop-menu" class="modal">
            <h2>SKLEP SURVIVALA</h2>
            <div id="shop-list" class="card-list"></div>
            <button class="close-btn" onclick="closeModals()">ZAMKNIJ</button>
        </div>

        <div id="confirm-modal" class="modal" style="justify-content: center; align-items: center; background: rgba(0,0,0,0.85);">
            <div class="wood-modal-content">
                <div class="wood-modal-overlay"></div>
                <h2 style="border:none; font-size: 1.8rem; margin-bottom: 20px; text-shadow: 2px 2px 4px #000; color: #fff;">
                    Czy na pewno chcesz wr√≥ciƒá do menu g≈Ç√≥wnego?<br>
                    <span style="font-size: 1.2rem; color: #ccc;">Obecna gra zostanie zako≈Ñczona.</span>
                </h2>
                <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                    <button class="wood-btn" style="background: linear-gradient(to bottom, #d32f2f, #9a0007); border-color: #500; color: #fff; width: auto; padding: 10px 30px; flex:1;" onclick="hardReset()">TAK</button>
                    <button class="wood-btn" style="background: linear-gradient(to bottom, #4CAF50, #2E7D32); border-color: #050; color: #fff; width: auto; padding: 10px 30px; flex:1;" onclick="closeConfirmModal()">GRAM DALEJ</button>
                </div>
            </div>
        </div>

        <div id="controls">
            <div id="math-panel">Gotowy?</div>
            
            <div id="top-controls-row">
                <div id="inventory-bar" class="day-locked">
                    <div class="item-slot" id="slot-potion" onclick="useItem('potion')">üåø <div class="item-count" id="count-potion">1</div></div>
                    <div class="item-slot" id="slot-bomb" onclick="useItem('bomb')">‚öôÔ∏è <div class="item-count" id="count-bomb">0</div></div>
                    <div class="item-slot" id="slot-shield" onclick="useItem('shield')">üõ°Ô∏è <div class="item-count" id="count-shield">0</div></div>
                    <div class="item-slot" id="slot-laser" onclick="useItem('laser')" style="border-color: #2196F3">ü™ì <div class="item-count" id="count-laser">0</div></div>
                </div>
                <button id="btn-exit-game" onclick="showConfirmModal()">X</button>
            </div>

            <div id="action-buttons" class="action-row">
                <button class="ctrl-btn" id="btn-gather" onclick="startGatherTask()">‚õèÔ∏è ZBIERAJ</button>
                <button class="ctrl-btn" id="btn-shop" onclick="openShop()">üõí SKLEP</button>
                <button class="ctrl-btn" id="btn-build" onclick="openBuild()">‚õ∫ BAZA</button>
            </div>
            <div id="keypad">
                <button class="key" onclick="input(1)">1</button><button class="key" onclick="input(2)">2</button><button class="key" onclick="input(3)">3</button>
                <button class="key" onclick="input(4)">4</button><button class="key" onclick="input(5)">5</button><button class="key" onclick="input(6)">6</button>
                <button class="key" onclick="input(7)">7</button><button class="key" onclick="input(8)">8</button><button class="key" onclick="input(9)">9</button>
                <button class="key key-fix" onclick="clearInput()">POPRAW</button><button class="key" onclick="input(0)">0</button><button class="key key-ok" onclick="checkAnswer()">OK</button>
            </div>
        </div>

    </div> <script>
        // --- DANE ---
        const MATH_DATA = { 1: [], 2: [], 3: [], 4: [] };
        for (let a = 1; a <= 10; a++) {
            for (let b = 1; b <= 10; b++) {
                const p = a * b;
                if (p <= 10) MATH_DATA[1].push({a, b});
                if (p <= 20) MATH_DATA[2].push({a, b});
                if (p <= 50) MATH_DATA[3].push({a, b});
                if (p <= 100) MATH_DATA[4].push({a, b}); 
            }
        }

        const levels = [
            { lvl: 1, name: "Sza≈Ças", res: "wood", cost: 0, hp: 120, def: 1 },
            { lvl: 2, name: "Ma≈Çy Namiot", res: "wood", cost: 20, hp: 180, def: 3 },
            { lvl: 3, name: "Ognisko", res: "wood", cost: 40, hp: 300, def: 6 },
            { lvl: 4, name: "Zasieki", res: "wood", cost: 80, hp: 450, def: 10 },
            { lvl: 5, name: "Kamienny KrƒÖg", res: "stone", cost: 50, hp: 750, def: 20 },
            { lvl: 6, name: "Wie≈ºa", res: "stone", cost: 100, hp: 1300, def: 35 },
            { lvl: 7, name: "Le≈õna Twierdza", res: "stone", cost: 200, hp: 3000, def: 60 }
        ];

        const items = {
            potion: { name: "Zio≈Ça", cost: 100, icon: "üåø", desc: "+50 HP", buyable: true },
            bomb:   { name: "Pu≈Çapka",  cost: 100, icon: "‚öôÔ∏è", desc: "Zabija potwora", buyable: true },
            shield: { name: "Barykada", cost: 100, icon: "üõ°Ô∏è", desc: "Blok (5s)", buyable: true },
            laser: { name: "Toporek", cost: 0, icon: "ü™ì", desc: "Rzadki przedmiot", buyable: false } 
        };

        const monsterTypes = ['m-slime', 'm-goblin', 'm-eye', 'm-golem', 'm-fire', 'm-skeleton', 'm-mushroom', 'm-spider', 'm-ghost', 'm-minotaur'];
        const mathConfig = { 1: { max: 10, label: "≈ÅATWY" }, 2: { max: 20, label: "≈öREDNI" }, 3: { max: 50, label: "TRUDNY" }, 4: { max: 100, label: "ULTRA" } };

        let state = {
            res: 0, gold: 0, hp: 120, maxHp: 120, lvl: 0, night: 1, phase: "day", timeLeft: 60,
            isShielded: false, inv: { potion: 1, bomb: 0, shield: 0, laser: 0 }, 
            inputLocked: false, activeMath: false, mathMode: 'none', dmgInterval: null, intervalId: null,
            mathTier: 1, streak: 0, mistakes: [], completedStreaks: 0, lastA: 0, lastB: 0
        };
        let math = { a:0, b:0, res:0, inp:"" };
        
        // --- SOUND SYSTEM ---
        const SoundSystem = {
            ctx: null, dayOsc: [], nightOsc: [], isMuted: false,
            init: function() {
                if(this.ctx) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                this.setupAmbience();
            },
            resume: function() { if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume(); },
            setupAmbience: function() {
                this.dayGain = this.ctx.createGain(); this.dayGain.gain.value = 0; this.dayGain.connect(this.ctx.destination);
                [110, 130.81].forEach(freq => { let osc = this.ctx.createOscillator(); osc.type = 'sine'; osc.frequency.value = freq; osc.connect(this.dayGain); osc.start(); this.dayOsc.push(osc); });
                this.nightGain = this.ctx.createGain(); this.nightGain.gain.value = 0; this.nightGain.connect(this.ctx.destination);
                [55, 110, 112].forEach(freq => { let osc = this.ctx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = freq; let filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 400; osc.connect(filter); filter.connect(this.nightGain); osc.start(); this.nightOsc.push(osc); });
            },
            setAmbience: function(phase) {
                if (!this.ctx) this.init(); this.resume(); const now = this.ctx.currentTime; const time = 2; 
                if (phase === 'day') { this.dayGain.gain.setTargetAtTime(0.02, now, time); this.nightGain.gain.setTargetAtTime(0, now, time); } 
                else { this.dayGain.gain.setTargetAtTime(0, now, time); this.nightGain.gain.setTargetAtTime(0.15, now, time); }
            },
            playSFX: function(type) {
                if (!this.ctx) this.init(); this.resume(); const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination);
                switch (type) {
                    case 'hit': osc.type='square'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(40, t+0.2); gain.gain.setValueAtTime(0.3, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.2); osc.start(t); osc.stop(t+0.2); break;
                    case 'potion': osc.type='sine'; osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(1200, t+0.3); gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.5); osc.start(t); osc.stop(t+0.5); break;
                    case 'bomb': case 'laser': { const bS=this.ctx.sampleRate*0.5; const buf=this.ctx.createBuffer(1,bS,this.ctx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<bS;i++) d[i]=Math.random()*2-1; const n=this.ctx.createBufferSource(); n.buffer=buf; const f=this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=800; n.connect(f); f.connect(gain); gain.gain.setValueAtTime(0.5, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.5); n.start(t); break; }
                    case 'shield': osc.type='sawtooth'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(600, t+0.3); gain.gain.setValueAtTime(0.2, t); gain.gain.setValueAtTime(0.05, t+0.1); gain.gain.setValueAtTime(0.2, t+0.2); gain.gain.linearRampToValueAtTime(0, t+0.5); osc.start(t); osc.stop(t+0.5); break;
                    case 'ui': osc.type='sine'; osc.frequency.setValueAtTime(800, t); gain.gain.setValueAtTime(0.05, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.05); osc.start(t); osc.stop(t+0.05); break;
                    case 'win': osc.type='triangle'; osc.frequency.setValueAtTime(440, t); osc.frequency.setValueAtTime(554, t+0.1); gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.3); osc.start(t); osc.stop(t+0.3); break;
                }
            }
        };

        function playTransition(color) {
            const t = document.getElementById('transition-layer'); t.style.backgroundColor = color; t.style.opacity = 1;
            setTimeout(() => { t.style.opacity = 0; }, 1000); 
        }

        function showMainMenu() { document.getElementById('main-menu-screen').style.display = 'flex'; document.getElementById('difficulty-screen').style.display = 'none'; }
        function showDifficultySelect() { document.getElementById('main-menu-screen').style.display = 'none'; document.getElementById('difficulty-screen').style.display = 'flex'; }
        function selectTier(tier) { SoundSystem.init(); startGame(tier); }

        function startGame(tier) {
            state.mathTier = tier; document.getElementById('difficulty-screen').style.display = 'none'; document.body.classList.remove('night'); 
            document.getElementById('hud').style.display = 'flex'; document.getElementById('game-area').style.display = 'flex'; document.getElementById('controls').style.display = 'flex';
            SoundSystem.setAmbience('day'); init();
        }

        function init() {
            updateUI(); startDay();
            state.intervalId = setInterval(() => { if (state.timeLeft > 0) { state.timeLeft--; updateTimerDisplay(); } else { switchPhase(); } }, 1000);
        }

        function updateTimerDisplay() {
            const tBox = document.getElementById('timer-box'); tBox.innerText = (state.phase==='day' ? '‚òÄÔ∏è' : 'üåô') + ' ' + state.timeLeft + 's'; tBox.style.color = state.timeLeft <= 10 ? 'red' : '#fff';
        }

        function switchPhase() { if(state.phase === 'day') startNight(); else showNightScreen(); }

        function getWordForm(n, forms) { if (n === 1) return forms[0]; if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20)) return forms[1]; return forms[2]; }

        function showNightScreen() {
            stopDamage(); const nightWord = getWordForm(state.night, ['noc', 'noce', 'nocy']); document.getElementById('night-summary-val').innerText = `${state.night} ${nightWord}`;
            const sSum = document.getElementById('streak-summary'); sSum.innerText = state.completedStreaks > 0 ? `Ilo≈õƒá bezb≈Çƒôdnych serii: ${state.completedStreaks}` : "";
            document.getElementById('night-screen').style.display = 'flex'; SoundSystem.playSFX('win'); 
        }

        function showNotification(text, isGold = false) {
            const float = document.createElement('div'); float.className = isGold ? 'floating-msg msg-gold' : 'floating-msg'; float.innerText = text;
            document.body.appendChild(float); setTimeout(()=>float.remove(), 2000);
        }
        
        // --- NOWA FUNKCJA ANIMACJI UI ---
        function showUIFeedback(element, text, color='#0f0') {
            const rect = element.getBoundingClientRect();
            const el = document.createElement('div');
            el.className = 'ui-feedback';
            el.innerText = text;
            el.style.color = color;
            el.style.left = (rect.left + rect.width/2) + 'px';
            el.style.top = (rect.top) + 'px';
            // Wycentrowanie
            el.style.transform = "translate(-50%, 0)";
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function startDay() {
            playTransition('white'); SoundSystem.setAmbience('day'); document.getElementById('night-screen').style.display = 'none'; 
            state.phase = 'day'; state.timeLeft = 60; document.body.classList.remove('night');
            document.getElementById('inventory-bar').classList.add('day-locked'); document.getElementById('monster-power').style.opacity = 0; stopDamage();
            if(state.activeMath) closeMath(); 
            document.getElementById('action-buttons').style.display = 'flex'; document.getElementById('keypad').style.display = 'none'; 
            document.getElementById('math-panel').innerText = "ZBIERAJ SUROWCE!"; document.getElementById('math-panel').style.borderColor = "var(--c-hp)";
            state.hp = Math.min(state.hp + 30, state.maxHp); updateUI();
        }

        function startNight() {
            playTransition('black'); SoundSystem.setAmbience('night'); SoundSystem.playSFX('ui'); closeModals();
            state.phase = 'night'; state.timeLeft = 60; state.night++; document.body.classList.add('night');
            document.getElementById('inventory-bar').classList.remove('day-locked'); document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('keypad').style.display = 'grid'; document.getElementById('keypad').classList.add('inactive');
            document.getElementById('math-panel').innerText = "NOC NADCHODZI..."; updateUI(); spawnMonsterLoop();
        }

        function startGatherTask() { state.activeMath = true; state.mathMode = 'gather'; document.getElementById('action-buttons').style.display = 'none'; document.getElementById('keypad').style.display = 'grid'; unlockInput(); generateMath(); }

        function spawnMonsterLoop() { if(state.phase !== 'night') return; lockInput("Czekaj..."); setTimeout(() => { if(state.phase === 'night') monsterAttack(); }, Math.random() * 1500 + 1000); }

        function monsterAttack() {
            state.activeMath = true; state.mathMode = 'defend'; unlockInput();
            const m = document.getElementById('monster'); m.className = ''; const rM = monsterTypes[Math.floor(Math.random() * monsterTypes.length)]; m.classList.add(rM);
            m.style.opacity = 1; m.style.transition = "none"; m.style.transform = "scale(1)";
            setTimeout(() => { m.style.transition = "transform 8s linear"; m.style.transform = "scale(3)"; }, 50);
            generateMath(); document.getElementById('math-panel').style.borderColor = "red";
            let power = 5 + (state.night * 6); let def = levels[state.lvl].def; let dmg = Math.max(Math.ceil(power * 0.1), power - def);
            const pwrDiv = document.getElementById('monster-power'); pwrDiv.innerHTML = `‚öîÔ∏è ATAK: ${dmg}`; pwrDiv.style.opacity = 1;
            clearInterval(state.dmgInterval); state.dmgInterval = setInterval(() => { if(!state.isShielded) takeDamage(dmg); }, 1200);
        }

        function takeDamage(amt) {
            SoundSystem.playSFX('hit'); state.hp -= amt; updateUI();
            document.getElementById('game-area').classList.add('shake-screen'); document.getElementById('flash-overlay').style.opacity = 0.3;
            setTimeout(() => { document.getElementById('game-area').classList.remove('shake-screen'); document.getElementById('flash-overlay').style.opacity = 0; }, 100);
            if(state.hp <= 0) gameOver();
        }

        function gameOver() {
            clearInterval(state.dmgInterval); clearInterval(state.intervalId);
            const nightWord = getWordForm(state.night, ['noc', 'noce', 'nocy']); document.getElementById('final-night').innerText = `${state.night} ${nightWord}`;
            const rec = document.getElementById('recommendation');
            if (state.completedStreaks > 0 && state.mathTier < 4) { let nextLabel = mathConfig[state.mathTier + 1].label; rec.innerText = `≈öwietnie ci idzie! Ilo≈õƒá bezb≈Çƒôdnych serii: ${state.completedStreaks}. Spr√≥buj poziomu: ${nextLabel}!`; } else { rec.innerText = ""; }
            const list = document.getElementById('mistakes-list'); list.innerHTML = "";
            if(state.mistakes.length === 0) list.innerHTML = "<li>Brak b≈Çƒôd√≥w! Brawo!</li>";
            else { [...new Set(state.mistakes)].forEach(m => { const li = document.createElement('li'); li.innerText = m; list.appendChild(li); }); }
            document.getElementById('game-over-screen').style.display = 'flex';
        }

        function showConfirmModal() { document.getElementById('confirm-modal').style.display = 'flex'; SoundSystem.playSFX('ui'); }
        function closeConfirmModal() { document.getElementById('confirm-modal').style.display = 'none'; SoundSystem.playSFX('ui'); }

        function hardReset() {
            closeConfirmModal(); clearInterval(state.dmgInterval); clearInterval(state.intervalId);
            state = { res: 0, gold: 0, hp: 120, maxHp: 120, lvl: 0, night: 1, phase: "day", timeLeft: 60, isShielded: false, inv: { potion: 1, bomb: 0, shield: 0, laser: 0 }, inputLocked: false, activeMath: false, mathMode: 'none', dmgInterval: null, intervalId: null, mathTier: 1, streak: 0, mistakes: [], completedStreaks: 0, lastA: 0, lastB: 0 };
            document.getElementById('game-over-screen').style.display = 'none'; document.getElementById('night-screen').style.display = 'none'; document.getElementById('hud').style.display = 'none'; document.getElementById('game-area').style.display = 'none'; document.getElementById('controls').style.display = 'none'; document.body.classList.remove('night');
            showMainMenu(); document.getElementById('monster').style.opacity = 0; document.getElementById('monster-power').style.opacity = 0; document.querySelectorAll('.dropped-item').forEach(e => e.remove()); updateUI(); SoundSystem.playSFX('ui');
        }

        function generateMath() {
            const tierProblems = MATH_DATA[state.mathTier]; let problem; let attempts = 0;
            do { attempts++; const randomIndex = Math.floor(Math.random() * tierProblems.length); problem = tierProblems[randomIndex]; } while ((problem.a === state.lastA && problem.b === state.lastB) && attempts < 5 && tierProblems.length > 1);
            state.lastA = problem.a; state.lastB = problem.b; math.a = problem.a; math.b = problem.b; math.res = problem.a * problem.b; math.inp = ""; updateMathDisplay();
        }

        function updateMathDisplay() { if(state.inputLocked) return; document.getElementById('math-panel').innerText = `${math.a} √ó ${math.b} = ${math.inp}`; }
        function input(n) { if(state.inputLocked) return; math.inp += n; updateMathDisplay(); SoundSystem.playSFX('ui'); }
        function clearInput() { if(state.inputLocked) return; math.inp = ""; updateMathDisplay(); }

        function checkAnswer() {
            if(state.inputLocked) return;
            if(parseInt(math.inp) === math.res) { state.streak++; updateProgression(); success(); } 
            else { SoundSystem.playSFX('hit'); document.getElementById('math-panel').style.borderColor = "red"; state.mistakes.push(`${math.a} √ó ${math.b} = ${math.res}`); state.streak = 0; updateProgression(); math.inp = ""; updateMathDisplay(); setTimeout(()=>document.getElementById('math-panel').style.borderColor="var(--c-hp)", 200); }
        }

        function updateProgression() {
            let pct = (state.streak / 5) * 100; if(pct > 100) pct = 100;
            const bar = document.getElementById('prog-fill'); bar.style.width = pct + "%";
            if(state.streak >= 5) { state.streak = 0; state.completedStreaks++; bar.style.width = "0%"; showNotification("+1 SERIA BEZB≈ÅƒòDNA!", true); spawnLoot('laser', 1); SoundSystem.playSFX('win'); }
        }

        function success() {
            SoundSystem.playSFX('win'); 
            if(state.phase === 'day') { spawnLoot('resource', 5 + state.night); if(Math.random() < 0.5) spawnLoot('gold', Math.floor(Math.random()*10) + 15); closeMath(); document.getElementById('math-panel').innerText = "DOBRA ROBOTA!"; } 
            else { stopDamage(); spawnLoot('gold', 40 + (state.night * 5)); if(Math.random() < 0.3) { const lI = ['potion', 'bomb', 'shield']; spawnLoot(lI[Math.floor(Math.random()*3)], 1); } lockInput("POKONANY!"); document.getElementById('monster-power').style.opacity = 0; setTimeout(() => { spawnMonsterLoop(); }, 1200); }
        }

        function lockInput(msg) { state.inputLocked = true; document.getElementById('math-panel').innerText = msg; document.getElementById('math-panel').classList.add('locked'); document.getElementById('keypad').classList.add('inactive'); }
        function unlockInput() { state.inputLocked = false; document.getElementById('math-panel').classList.remove('locked'); document.getElementById('keypad').classList.remove('inactive'); document.getElementById('math-panel').style.borderColor = "var(--c-hp)"; }
        function closeMath() { state.activeMath = false; state.mathMode = 'none'; state.inputLocked = false; document.getElementById('action-buttons').style.display = 'flex'; document.getElementById('keypad').style.display = 'none'; }

        function spawnLoot(type, amount) {
            const el = document.createElement('div'); el.className = 'dropped-item'; let icon = "‚ùì"; let color = "#fff";
            if(type === 'gold') { icon = "üí∞"; color="gold"; } else if(type === 'resource') { icon = levels[state.lvl].res === 'wood' ? 'ü™µ' : (levels[state.lvl].res === 'stone' ? 'ü™®' : 'üî©'); color="orange"; } else { if(items[type]) { icon = items[type].icon; if(type==='laser') color="#2196F3"; } else { return; } }
            el.innerText = icon; el.style.left = (20 + Math.random() * 60) + '%'; el.style.top = (20 + Math.random() * 40) + '%';
            el.onclick = function(e) {
                collectLoot(type, amount); const float = document.createElement('div'); float.className = 'floating-msg';
                let msgC = ""; if(type === 'gold') msgC = `+${amount} üí∞`; else if(type === 'resource') { let rI = levels[state.lvl].res === 'wood' ? 'ü™µ' : 'ü™®'; msgC = `+${amount} ${rI}`; } else { msgC = `${items[type].icon} ${items[type].name.toUpperCase()}`; }
                float.innerText = msgC; float.style.color = color; document.getElementById('game-area').appendChild(float); setTimeout(()=>float.remove(), 1500); el.remove(); SoundSystem.playSFX('win'); 
            };
            document.getElementById('game-area').appendChild(el); setTimeout(() => { if(el.parentNode) el.remove(); }, 8000);
        }

        function collectLoot(type, amount) { if(type === 'resource') state.res += amount; else if(type === 'gold') state.gold += amount; else state.inv[type]++; updateUI(); }
        function stopDamage() { clearInterval(state.dmgInterval); document.getElementById('monster').style.opacity = 0; }

        function useItem(type) {
            if(state.phase === 'day') { showNotification("Teraz zdobywaj i kupuj - wykorzystasz je w nocy!"); return; }
            if(state.inv[type] > 0) {
                state.inv[type]--;
                if(type === 'potion') { state.hp = Math.min(state.hp + 50, state.maxHp); SoundSystem.playSFX('potion'); }
                else if(type === 'bomb') { if(state.mathMode==='defend') { SoundSystem.playSFX('bomb'); success(); } }
                else if(type === 'laser') { if(state.mathMode==='defend') { SoundSystem.playSFX('laser'); success(); } }
                else if(type === 'shield') { SoundSystem.playSFX('shield'); state.isShielded = true; document.getElementById('game-area').style.border = "5px solid #00e5ff"; setTimeout(()=>{ state.isShielded = false; document.getElementById('game-area').style.border="none"; }, 5000); }
                updateUI();
            }
        }

        function openShop() { renderList('shop-list', items, true); document.getElementById('shop-menu').style.display = 'flex'; }
        function openBuild() { renderList('build-list', levels, false); document.getElementById('build-menu').style.display = 'flex'; }
        
        function renderList(id, data, isShop) {
            const list = document.getElementById(id); list.innerHTML = ""; const entries = isShop ? Object.keys(data) : data;
            entries.forEach((key, i) => {
                let item, canBuy, isOwned = false, costIcon = "üí∞";
                if(isShop) { item = data[key]; if(item.buyable === false) return; canBuy = state.gold >= item.cost; } 
                else { item = key; if(i > state.lvl + 1) return; isOwned = i <= state.lvl; canBuy = (i === state.lvl + 1) && state.res >= item.cost; costIcon = item.res === 'wood' ? 'ü™µ' : (item.res === 'stone' ? 'ü™®' : 'üî©'); }
                
                // NAPRAWIONO IKONY W MENU (u≈ºycie 60px zamiast 220px)
                const menuSize = 60; 
                const cols = 4; const colIdx = i % cols; const rowIdx = Math.floor(i / cols);
                const xPos = -(colIdx * menuSize); const yPos = -(rowIdx * menuSize);
                let iconHtml = isShop ? `<div style="font-size:2rem">${item.icon}</div>` : `<div class="menu-sprite" style="background-position: ${xPos}px ${yPos}px;"></div>`;

                const div = document.createElement('div'); div.className = `card ${canBuy ? 'affordable' : ''}`; div.style.opacity = isOwned ? 0.5 : 1;
                // DODANO 'this' DO ONCLICK ABY Z≈ÅAPAƒÜ PRZYCISK DLA ANIMACJI
                div.innerHTML = `
                    ${iconHtml}
                    <div style="flex:1"> <div style="font-weight:bold">${item.name}</div> <div style="font-size:0.8rem">${isShop ? item.desc : 'Def: ' + item.def}</div> </div>
                    <div>${isOwned ? '‚úÖ' : item.cost + costIcon}</div>
                    ${canBuy ? `<button class="btn-buy" onclick="${isShop ? `buyShop('${key}', this)` : `upgradeBase(${i}, this)`}">KUP</button>` : ''}
                `;
                list.appendChild(div);
            });
        }

        function buyShop(key, btn) {
            const item = items[key];
            if(state.gold >= item.cost) {
                state.gold -= item.cost; state.inv[key]++; updateUI(); 
                showUIFeedback(btn, "+1"); // Animacja
                openShop(); SoundSystem.playSFX('ui'); 
            }
        }

        function upgradeBase(i, btn) {
            const next = levels[i];
            if(state.res >= next.cost) {
                state.res -= next.cost; state.lvl = i; state.maxHp = next.hp; state.hp = state.maxHp;
                updateUI(); 
                showUIFeedback(btn, "ULEPSZONO!", "#fff"); // Animacja
                closeModals(); SoundSystem.playSFX('win'); 
            }
        }

        function closeModals() { document.getElementById('shop-menu').style.display = 'none'; document.getElementById('build-menu').style.display = 'none'; }

        function updateUI() {
            const lvl = levels[state.lvl]; let rIcon = lvl.res === 'wood' ? 'ü™µ' : (lvl.res === 'stone' ? 'ü™®' : 'üî©');
            document.getElementById('night-val').innerText = state.night; document.getElementById('res-icon').innerText = rIcon;
            document.getElementById('res-count').innerText = state.res; document.getElementById('gold-count').innerText = state.gold;
            
            // Tutaj u≈ºywamy baseSize=220 dla du≈ºej bazy
            const baseSize = 220; const cols = 4; const colIdx = state.lvl % cols; const rowIdx = Math.floor(state.lvl / cols);
            const xPos = -(colIdx * baseSize); const yPos = -(rowIdx * baseSize);
            document.getElementById('base-visual').style.backgroundPosition = `${xPos}px ${yPos}px`;
            
            document.getElementById('base-name').innerText = lvl.name; document.getElementById('base-def').innerText = lvl.def;
            let pct = (state.hp / state.maxHp) * 100; document.getElementById('hp-fill').style.width = Math.max(0, pct) + "%"; document.getElementById('hp-fill').style.background = pct < 30 ? 'red' : 'var(--c-hp)'; document.getElementById('hp-text').innerText = `${state.hp}/${state.maxHp}`;
            for(let k in state.inv) document.getElementById('count-'+k).innerText = state.inv[k];
            
            const next = levels[state.lvl+1]; const btn = document.getElementById('btn-build');
            if(next && state.res >= next.cost) { btn.classList.add('ready'); btn.innerText = "‚è´ ULEPSZ!"; } else { btn.classList.remove('ready'); btn.innerText = "‚õ∫ BAZA"; }
        }

        showMainMenu();
    </script>
</body>
</html>
